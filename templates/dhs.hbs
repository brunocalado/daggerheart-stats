<div class="chartdice" id="chartdice">
    {{#if hasData}}
    
    <!-- Selections Container -->
    <div class="selections-container" id="selections-container">
        
        <!-- Save Button (GM Only) -->
        {{#if isGM}}
        <div class="input-group" style="align-items: center;">
             <label for="save-btn-toggle" style="opacity: 0; height: 0; margin: 0;">Save</label>
            <button id="save-btn-toggle" type="button" data-action="toggleSave" class="icon-btn" style="color: {{saveIconColor}};" title="Toggle Data Recording">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
        {{else}}
        <div class="input-group" style="align-items: center; justify-content: center;">
            <span style="color: {{saveIconColor}}; font-size: 1.2em; padding: 0 10px;" title="Recording Status">
                <i class="fas fa-circle"></i>
            </span>
        </div>
        {{/if}}

        <!-- User Select -->
        <div class="floating-label-group">
            <span class="input-label">User</span>
            <select id="selectuser" name="whichusr" class="compact-select"> {{{whichuser}}}</select>
        </div>
        
        <!-- Date From -->
        <div class="floating-label-group">
            <span class="input-label">From</span>
            <select id="fromdateselect" name="datefrom" class="compact-select"> {{{messagealldatesfrom}}}</select>
        </div>
        
        <!-- Date To -->
        <div class="floating-label-group">
            <span class="input-label">To</span>
            <select id="todateselect" name="dateto" class="compact-select">{{{messagealldatesto}}}</select>
        </div>

        <!-- Roll Type Filter -->
        <div class="floating-label-group" id="filter-rolltype-group">
            <span class="input-label">Type</span>
            <select id="filter-rolltype" class="compact-select">
                <option value="all">All</option>
                <option value="action">Action</option>
                <option value="reaction">Reaction</option>
            </select>
        </div>

        <!-- Buttons Group -->
        <div class="input-group" style="justify-content: flex-end; flex-direction: row; gap: 5px;">
             <!-- Refresh Button -->
            <div>
                <label style="opacity: 0; height: 0; margin: 0; display:block;">Ref</label>
                <button type="button" data-action="refreshData" class="icon-btn manage-btn" title="Refresh Statistics">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

             <!-- Summary Button -->
            <div>
                <label style="opacity: 0; height: 0; margin: 0; display:block;">Sum</label>
                <button type="button" data-action="openSummary" class="icon-btn manage-btn" title="View Summary">
                    <i class="fas fa-clipboard-list"></i>
                </button>
            </div>

             <!-- Trends Button -->
            <div>
                <label style="opacity: 0; height: 0; margin: 0; display:block;">Trd</label>
                <button type="button" data-action="openTrends" class="icon-btn manage-btn" title="View Trends">
                    <i class="fas fa-chart-line"></i>
                </button>
            </div>

            <!-- Settings (GM Only) -->
            {{#if isGM}}
            <div>
                <label style="opacity: 0; height: 0; margin: 0; display:block;">Mng</label> 
                <button type="button" data-action="manageData" class="icon-btn manage-btn" title="Manage Data">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            {{/if}}
        </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-wrapper">
        <div id="roll-label">Count</div>
        
        <div class="chart-content" id="allthebars">
            {{{appcontent}}}
        </div>
    </div>

    <!-- Separator -->
    <hr class="stats-separator">

    <!-- Stats Boxes Container -->
    <div class="tablescontainer">
        <!-- GM Stats Box (UPDATED to 4 Columns) -->
        <div id="gm-stats-container" class="stat-box" style="display: {{#if isSelectedUserGM}}block{{else}}none{{/if}};">
            
            <div class="dh-stat-grid">
                <!-- Column 1: Total D20 Rolls -->
                <div class="dh-stat-col">
                    <span class="stat-line" title="Total amount of d20 rolls made.">
                        Total D20 Rolls: <span class="stat-value" id="gmD20Count">{{{gmD20Count}}}</span>
                    </span>
                </div>

                <!-- Column 2: Criticals & Fumbles -->
                <div class="dh-stat-col">
                    <span class="stat-line" title="Number of Critical Successes">
                        Critical Hits: <span class="stat-value" id="gmCrits" style="color: #388E3C;">{{{gmCrits}}}</span>
                    </span>
                    <span class="stat-line" title="Fumbles (Natural 1)">
                        Fumbles: <span class="stat-value" id="gmFumbles" style="color: #D32F2F;">{{{gmFumbles}}}</span>
                    </span>
                </div>
                
                <!-- Column 3: Hits / Misses -->
                <div class="dh-stat-col">
                    <div class="stat-line" title="Counted only if an action roll was made with a marked target.">
                        Hits: <span class="stat-value" id="gmHits" style="color: #388E3C;">{{{gmHits}}}</span>
                    </div>
                    <div class="stat-line" title="Counted only if an action roll was made with a marked target.">
                        Misses: <span class="stat-value" id="gmMisses" style="color: #D32F2F;">{{{gmMisses}}}</span>
                    </div>
                </div>
                
                <!-- Column 4: Fear Earned / Spent -->
                <div class="dh-stat-col">
                    <div class="stat-line">
                        Fear Earned: <span class="stat-value" id="gmFearGain" style="color: var(--dh-color-fear);">{{{gmFearGain}}}</span>
                    </div>
                    <div class="stat-line">
                        Fear Spent: <span class="stat-value" id="gmFearSpend" style="color: var(--dh-color-gold);">{{{gmFearSpend}}}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Duality Stats Box (Players) - UPDATED to 4 Columns -->
        <div id="duality-stats-container" class="stat-box" style="display: {{#if isSelectedUserGM}}none{{else}}block{{/if}};">
            
            <div class="dh-stat-grid">
                <!-- Column 1: Hope & Fear Rolls -->
                <div class="dh-stat-col">
                    <span class="stat-line">
                        Rolls with Hope: <span class="stat-value" id="dualityHope" style="color: var(--dh-color-hope);">{{{dualityHope}}}</span>
                    </span>
                    <span class="stat-line" style="margin-top: 5px;">
                        Rolls with Fear: <span class="stat-value" id="dualityFear" style="color: var(--dh-color-fear);">{{{dualityFear}}}</span>
                    </span>
                </div>

                <!-- Column 2: Criticals (Isolated) -->
                <div class="dh-stat-col">
                    <span class="stat-line" title="Number of Critical Successes">
                        Critical Hits: <span class="stat-value" id="dualityCrit" style="color: #4CAF50;">{{{dualityCrit}}}</span>
                    </span>
                </div>

                <!-- Column 3: Hits & Miss -->
                <div class="dh-stat-col">
                    <div class="stat-line" title="Counted only if an action roll was made with a marked target.">
                        Hits: <span class="stat-value" id="playerHits" style="color: #388E3C;">{{{playerHits}}}</span>
                    </div>
                    <div class="stat-line" title="Counted only if an action roll was made with a marked target.">
                        Misses: <span class="stat-value" id="playerMisses" style="color: #D32F2F;">{{{playerMisses}}}</span>
                    </div>
                </div>

                <!-- Column 4: Hope Earned & Fear Generated -->
                <div class="dh-stat-col">
                    <div class="stat-line" title="Count of Action Rolls that resulted in Hope or Critical">
                        Hope Earned: <span class="stat-value" id="playerHopeEarned" style="color: var(--dh-color-hope);">{{{playerHopeEarned}}}</span>
                    </div>
                    <div class="stat-line" title="Count of Action Rolls that resulted in Fear">
                        Fear Generated: <span class="stat-value" id="playerFearGenerated" style="color: var(--dh-color-fear);">{{{playerFearGenerated}}}</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    {{else}}
    <div style="padding: 40px; text-align: center; color: var(--dh-color-text);">
        <h3 style="font-family: var(--dh-font-header); font-weight: bold; margin-bottom: 10px;">No Data Found</h3>
        <p>Ensure "Pause Data Acquisition" is OFF and make some rolls!</p>
    </div>
    {{/if}}
</div>